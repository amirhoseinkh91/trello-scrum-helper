<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
  </head>

  <body>
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <script>
      var showEstimates = async function (t, opts) {
        return t.popup({
          title: "Select a list:",
          items: await t.lists("id", "name").then(
            await function (lists) {
              return lists.map(function (list) {
                return {
                  text: list.name,
                  callback: async function (t, opts) {
                    var cardsInList = await t
                      .cards("all")
                      .then(function (cards) {
                        return cards.filter(function (card) {
                          return card.idList == list.id;
                        });
                      });
                      const estimatePerMember = []
                      function addEstimateToMember(member, hours) {
                        let obj = estimatePerMember.find(item => item.username == member)
                        if (obj != null) {
                          obj.estimates = (obj.estimates || 0 ) + hours
                        } else {
                          obj = {
                            username: member,
                            estimates: hours
                          }
                          estimatePerMember.push(obj)
                        }
                      }
                      cardsInList.forEach(card => {
                        if (card.members.length == 0) {
                          addEstimateToMember('no assignee', 1)
                        } else {
                          card.members.forEach(cardMember => {
                            addEstimateToMember(cardMember.username, 1)
                          });
                        }
                      });
                    console.log('group', estimatePerMember)
                    t.popup({
                      title: 'Estimates',
                      items: estimatePerMember.map(function(item) {
                        console.log(item)
                         return {
                          text: item,
                          callback: function() {}
                         };
                      })
                    });
                  },
                };
              });
            }
          ),
          search: {
            count: 10,
            placeholder: "Search Lists",
            empty: "No List Found",
          },
        });
      };
      TrelloPowerUp.initialize({
        "board-buttons": async function (t, options) {
          return [
            {
              icon: {
                dark: "https://cdn.hyperdev.com/us-east-1%3A3d31b21c-01a0-4da2-8827-4bc6e88b7618%2Ficon-black.svg",
                light:
                  "https://cdn.hyperdev.com/us-east-1%3A3d31b21c-01a0-4da2-8827-4bc6e88b7618%2Ficon-white.svg",
              },
              text: "Estimates",
              callback: await showEstimates,
              condition: "edit",
            },
          ];
        },
      });
    </script>
  </body>
</html>
